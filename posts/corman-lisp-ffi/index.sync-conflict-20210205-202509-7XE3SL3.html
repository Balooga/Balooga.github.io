<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Luke Crook">
    <meta name="description" content="This post demonstrates the use of the Corman Common Lisp (CCL) FFI.[1] with the SDL[2] library. This post is not a general SDL tutorial, nor should it be considered a primer for learning Common Lisp. NOTE: SDL version 1.2.x is described. SDL APIs described herein have changed in SDL version 2.x.     Introduction This document will describe how Lisp code interfaces with Microsoft Windows Dynamic Link Libraries (DLL’s) using the Corman Common Lisp FFI.">
    <meta name="keywords" content="blog,developer,personal">

    
      <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Corman Lisp FFI Howto"/>
<meta name="twitter:description" content="This post demonstrates the use of the Corman Common Lisp (CCL) FFI.[1] with the SDL[2] library. This post is not a general SDL tutorial, nor should it be considered a primer for learning Common Lisp. NOTE: SDL version 1.2.x is described. SDL APIs described herein have changed in SDL version 2.x.     Introduction This document will describe how Lisp code interfaces with Microsoft Windows Dynamic Link Libraries (DLL’s) using the Corman Common Lisp FFI."/>

    <meta property="og:title" content="Corman Lisp FFI Howto" />
<meta property="og:description" content="This post demonstrates the use of the Corman Common Lisp (CCL) FFI.[1] with the SDL[2] library. This post is not a general SDL tutorial, nor should it be considered a primer for learning Common Lisp. NOTE: SDL version 1.2.x is described. SDL APIs described herein have changed in SDL version 2.x.     Introduction This document will describe how Lisp code interfaces with Microsoft Windows Dynamic Link Libraries (DLL’s) using the Corman Common Lisp FFI." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.balooga.com/posts/corman-lisp-ffi/" />
<meta property="article:published_time" content="2003-12-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2003-12-11T00:00:00+00:00" />


    
      <base href="https://www.balooga.com/posts/corman-lisp-ffi/">
    
    <title>
  Corman Lisp FFI Howto · Balooga
</title>

    
      <link rel="canonical" href="https://www.balooga.com/posts/corman-lisp-ffi/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://www.balooga.com/css/coder.min.0e5ce5b959a68dfe0232c6ddcec1e8ef154517c968464707f3181c437fe611c0.css" integrity="sha256-DlzluVmmjf4CMsbdzsHo7xVFF8loRkcH8xgcQ3/mEcA=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="https://www.balooga.com/css/github.css" />
    
      <link rel="stylesheet" href="https://www.balooga.com/css/custom.css" />
    

    

    <link rel="icon" type="image/png" href="https://www.balooga.com/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://www.balooga.com/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.80.0" />
  </head>
  
  
  
  <body class="colorscheme-light"
        onload=" twemoji.parse(document.body); "
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://www.balooga.com/">
      Balooga
    </a>
    
      <span id="dark-mode-toggle" class="float-right">
        <i class="fas fa-adjust fa-fw"></i>
      </span>
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fas fa-bars fa-fw"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://www.balooga.com/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://www.balooga.com/about/">About</a>
            </li>
          
        
        
        <li class="navigation-item separator">
          <span>|</span>
        </li>
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Corman Lisp FFI Howto</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2003-12-11T00:00:00Z'>
                December 11, 2003
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              12-minute read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        
        <div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
This post demonstrates the use of the Corman Common Lisp (CCL)
FFI.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> with the
SDL<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> library. This post is not a general SDL
tutorial, nor should it be considered a primer for learning Common Lisp. NOTE:
SDL version 1.2.x is described. SDL APIs described herein have changed in SDL
version 2.x.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a><a class="link" href="#_introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document will describe how Lisp code interfaces with Microsoft Windows
Dynamic Link Libraries (DLL’s) using the Corman Common Lisp FFI. The FFI
bindings to SDL are used in many of the examples. This document makes use of an
existing example contained in the SDL documentation, &#34;Using OpenGL With
SDL&#34;.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
<div class="paragraph">
<p>Using the above example, the main components of the SDL library are described in
Lisp: initialization, configuration, event handling, drawing to the screen, and
exiting. Several Lisp ‘macros’ are later described in an attempt to show some of
the advantages of developing using Lisp as opposed to, say Java or C++.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The section on macros is TODO.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basics_of_the_corman_lisp_ffi"><a class="anchor" href="#_basics_of_the_corman_lisp_ffi"></a><a class="link" href="#_basics_of_the_corman_lisp_ffi">Basics of the Corman Lisp FFI</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains a brief introduction on the use of the Corman Lisp FFI.
The FFI is used to call C style functions from Dynamic Link Libraries (DLL’s).
The most common operations that a programmer may encounter when interfacing to a
DLL are covered, including callbacks, creating and referencing arrays and
structures, using pointers and managing memory.</p>
</div>
<div class="paragraph">
<p>The Corman Lisp
manual<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup> describes
how to create FFI definitions. This section assumes that the reader is using
existing FFI definitions and wishes to make use of the functions defined
therein. Advanced topics, such as interfacing to COM objects are not covered.
Please see the Corman Lisp manual for more information on how to use COM
objects.</p>
</div>
<div class="sect2">
<h3 id="_includes"><a class="anchor" href="#_includes"></a><a class="link" href="#_includes">Includes</a></h3>
<div class="paragraph">
<p>FFI definitions are usually contained in a file, similar to C header files. And
like C, these definitions must be included before use. In Lisp, require is used
for this purpose.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="cp">#include “SDL/SDL.h”
#include “GL/gl.h”</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">require</span> <span class="err">’</span><span class="nv">sdl</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span> <span class="err">‘</span><span class="nv">opengl</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_variables_c_datatypes"><a class="anchor" href="#_variables_c_datatypes"></a><a class="link" href="#_variables_c_datatypes">Variables: C Datatypes</a></h3>
<div class="paragraph">
<p>Lisp variables may be passed to or received from C style functions that take any
of the standard C datatypes as parameters. C datatypes include byte/char, short,
int, float, and double. Corman Lisp transparently takes care of much of the
necessary casting and conversion between Lisp and C variables.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nv">width</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">height</span> <span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="variables"><a class="anchor" href="#variables"></a><a class="link" href="#variables">Variables: C Arrays and Structures</a></h3>
<div class="paragraph">
<p>Things begin to get interesting when structures and arrays are used. Pure Lisp
arrays are not equivalent to C arrays and therefore it is not possible to pass a
Lisp array to a C function. If a C function takes an array a C style array must
be created from within Lisp.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">static</span> <span class="n">GLfloat</span> <span class="n">v0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span>  <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using C, arrays may be created on the stack as shown in the C code above.
When a C array is created in Lisp, it is always created on the heap - meaning it
must be created using malloc. Because Lisp is garbage collected there is no need
to explicitly free a variable created using malloc. The garbage collector will
automatically free the memory for <code>v0</code> when the variable goes out of scope.
Although there is nothing stopping the reader from explicitly freeing a variable
using the function free.</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nv">v0</span> <span class="p">(</span><span class="nv">ct:malloc</span> <span class="p">(</span><span class="nv">ct:sizeof</span> <span class="err">‘</span><span class="p">(</span><span class="ss">:single-float</span> <span class="mi">3</span><span class="p">))))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A C array may be initialized when it is created. In Lisp because C arrays are
created on the heap, assignment must take place as a separate step.</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="p">(</span><span class="ss">:single-float</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">v0</span> <span class="mi">0</span><span class="p">)</span> <span class="mf">-1.0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="p">(</span><span class="ss">:single-float</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">v0</span> <span class="mi">1</span><span class="p">)</span> <span class="mf">-1.0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="p">(</span><span class="ss">:single-float</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">v0</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>cref</code> (the ct: prefix identifies the package that contains cref) is used for
accessing a C style array, or structure. Therefore, looking at the statements
in the previous code block:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ct:cref</code> - accessing an array or structure.</p>
</li>
<li>
<p><code>(:single-float 3)</code> - in this case, it is an array of 3 floats.</p>
</li>
<li>
<p><code>v0</code> - the name of the array we previously created using malloc.</p>
</li>
<li>
<p><code>0</code> - The index into the array</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Lisp implementation seems backward compared to the C-style the reader is
probably used to, e.g <code>v0[0] = -1.</code> But that’s how it is done in CCL. It is
possible to improve upon this using macros</p>
</div>
<div class="paragraph">
<p>The previous code described assignment. Retrieving a value is much the same, but
without the <code>setf</code>.</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">ct:cref</span> <span class="p">(</span><span class="ss">:single-float</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">v0</span> <span class="mi">0</span><span class="p">)</span>

<span class="nv">-1.0</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code for accessing a C struct is described below.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Sint16</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">Sint16</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">Uint16</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">Uint16</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SDL_Rect</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nv">a-rectangle</span> <span class="p">(</span><span class="nv">ct:malloc</span> <span class="p">(</span><span class="nv">ct:sizeof</span> <span class="err">’</span><span class="nv">sdl:SDL_Rect</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Rect</span> <span class="nv">a-rectangle</span> <span class="nv">sdl::x</span><span class="p">)</span> <span class="mi">120</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Rect</span> <span class="nv">a-rectangle</span> <span class="nv">sdl::x</span><span class="p">)</span> <span class="mi">200</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Rect</span> <span class="nv">a-rectangle</span> <span class="nv">sdl::w</span><span class="p">)</span> <span class="mi">64</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Rect</span> <span class="nv">a-rectangle</span> <span class="nv">sdl::h</span><span class="p">)</span> <span class="mi">64</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The macro <code>with-c-struct</code> makes working with structs a lot easier, as shown
below:</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">with-c-struct</span> <span class="p">(</span><span class="nv">x</span> <span class="nv">rectangle</span> <span class="nv">sdl:SDL_Rect</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">setf</span>
          <span class="nv">sdl::x</span> <span class="mi">120</span>
          <span class="nv">sdl::y</span> <span class="mi">200</span>
          <span class="nv">sdl::w</span> <span class="mi">64</span>
          <span class="nv">sdl::h</span> <span class="mi">64</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>An important consideration is that the Lisp sizeof function can only be passed
defined types, for example <code>sdl:SDL_Rect</code>. Calling sizeof on a variable such as
<code>a-rectangle</code> will fail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_functions"><a class="anchor" href="#_functions"></a><a class="link" href="#_functions">Functions</a></h3>
<div class="paragraph">
<p>Calling C style functions in Lisp is straightforward.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">SDL_Init</span><span class="p">(</span> <span class="n">SDL_INIT_VIDEO</span> <span class="p">);</span>
<span class="n">SDL_GL_SetAttribute</span><span class="p">(</span> <span class="n">SDL_GL_RED_SIZE</span><span class="p">,</span> <span class="mi">5</span> <span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">SDL_Init</span> <span class="nv">SDL_INIT_VIDEO</span><span class="p">)</span>
<span class="p">(</span><span class="nv">SDL_GL_SetAttribute</span> <span class="nv">SDL_GL_RED_SIZE</span> <span class="mi">5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_callbacks"><a class="anchor" href="#_callbacks"></a><a class="link" href="#_callbacks">Callbacks</a></h3>
<div class="paragraph">
<p><code>defun-c-callback</code> is used to create a function callback in Lisp. As an example,
the C prototype for the SDL function <code>SDL_AddTimer</code> is shown below.
<code>SDL_AddTimer</code> takes a function as one of its parameters and calls that function
at the specified interval.</p>
</div>
<div class="listingblock">
<div class="title">C callback function prototype</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="nf">Uint32</span> <span class="p">(</span><span class="o">*</span><span class="n">SDL_NewTimerCallback</span><span class="p">)(</span><span class="n">Uint32</span> <span class="n">interval</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp callback function</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">ct:defun-c-callback</span> <span class="nv">timer-callback</span> <span class="p">((</span><span class="nv">interval</span> <span class="nv">SDL:Uint32</span><span class="p">)</span> <span class="p">(</span><span class="nv">param</span> <span class="p">(</span><span class="ss">:void</span> <span class="nb">*</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">fformat</span> <span class="err">“</span><span class="nv">Yup,</span> <span class="nv">timer</span> <span class="nv">Fired</span><span class="err">”</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">values</span> <span class="nv">interval</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">C <code>SDL_AddTimer</code> prototype definition</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">SDL_TimerID</span> <span class="nf">SDL_AddTimer</span><span class="p">(</span><span class="n">Uint32</span> <span class="n">interval</span><span class="p">,</span> <span class="n">SDL_NewTimerCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp code using a callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nv">param</span> <span class="p">(</span><span class="nv">ct:malloc</span> <span class="p">(</span><span class="nv">ct:sizeof</span> <span class="ss">:LONG</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">a-timer-1</span>
    <span class="p">(</span><span class="nv">SDL:SDL_AddTimer</span> <span class="mi">10000</span> <span class="p">(</span><span class="nv">ct:get-callback-procinst</span> <span class="err">‘</span><span class="nv">timer-callback</span><span class="p">)</span> <span class="nv">param</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pointers"><a class="anchor" href="#_pointers"></a><a class="link" href="#_pointers">Pointers</a></h3>
<div class="paragraph">
<p>All C objects are referenced from Lisp using pointers. For example in Section
<a href="#variables">Variables: C Arrays and Structures</a>, <code>v0</code> is a foreign pointer that points to an array of 3 floats.
The function <code>create-foreign-ptr</code> is used to create a foreign pointer. A foreign
pointer is similar to <code>void *</code> in C and can be cast (or assigned) to any object.
The function cpointer value returns the address of an object referenced by the
foreign pointer. It is therefore possible to assign the pointer to the address
of any object using setf. An example is described below. Values returned from
Corman Lisp are in bold.</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nv">f-pointer</span> <span class="p">(</span><span class="nv">ct:create-foreign-ptr</span><span class="p">))</span>
<span class="err">#</span><span class="nb">&lt;</span> <span class="nv">FOREIGN</span> <span class="nv">PTR:</span> <span class="m">#x0</span> <span class="nb">&gt;</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">var-1</span> <span class="p">(</span><span class="nv">ct:malloc</span> <span class="p">(</span><span class="nv">ct:sizeof</span> <span class="ss">:LONG</span><span class="p">)))</span>
<span class="err">#</span><span class="nb">&lt;</span> <span class="nv">FOREIGN</span> <span class="nv">HEAP</span> <span class="nv">PTR:</span> <span class="m">#xA63F78</span><span class="o">,</span> <span class="nb">length</span> <span class="nb">=</span> <span class="mi">4</span> <span class="nv">bytes</span> <span class="nb">&gt;</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="p">(</span><span class="ss">:long</span> <span class="nb">*</span><span class="p">)</span> <span class="nv">var-1</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">100</span><span class="p">)</span>
<span class="mi">100</span>

<span class="p">(</span><span class="nv">ct:cpointer-value</span> <span class="nv">f-pointer</span><span class="p">)</span>
<span class="mi">0</span>

<span class="p">(</span><span class="nv">ct:cpointer-value</span> <span class="nv">var-1</span><span class="p">)</span>
<span class="mi">10895224</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cpointer-value</span> <span class="nv">f-pointer</span><span class="p">)</span> <span class="p">(</span><span class="nv">ct:cpointer-value</span> <span class="nv">var-1</span><span class="p">))</span>
<span class="p">(</span><span class="nv">ct:cpointer-value</span> <span class="nv">f-pointer</span><span class="p">)</span>
<span class="mi">10895224</span>

<span class="p">(</span><span class="nv">ct:cref</span> <span class="p">(</span><span class="ss">:long</span> <span class="nb">*</span><span class="p">)</span> <span class="nv">f-pointer</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">100</span>

<span class="nv">var-1</span>
<span class="err">#</span><span class="nb">&lt;</span> <span class="nv">FOREIGN</span> <span class="nv">HEAP</span> <span class="nv">PTR:</span> <span class="m">#xA63F78</span><span class="o">,</span> <span class="nb">length</span> <span class="nb">=</span> <span class="mi">4</span> <span class="nv">bytes</span> <span class="nb">&gt;</span>

<span class="nv">f-pointer</span>
<span class="err">#</span><span class="nb">&lt;</span> <span class="nv">FOREIGN</span> <span class="nv">PTR:</span> <span class="m">#xA63F78</span> <span class="nb">&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="types"><a class="anchor" href="#types"></a><a class="link" href="#types">Defining types</a></h3>
<div class="paragraph">
<p>The function defctype is similar to the C typedef. It allows one to create new
types and reference them in Lisp code, greatly improving readability. The
following code modifies the example in Section <a href="#variables">Variables: C Arrays and Structures</a> and creates a new
type called <code>vertex-arrayf</code> which is defined as an array of three floats.</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">ct:defctype</span> <span class="nv">vertex-array</span> <span class="p">(</span><span class="ss">:single-float</span> <span class="mi">3</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">v0</span> <span class="p">(</span><span class="nv">ct:malloc</span> <span class="p">(</span><span class="nv">ct:sizeof</span> <span class="ss">&#39;vertex-arrayf</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">vertex-array</span> <span class="nv">v0</span> <span class="mi">0</span><span class="p">)</span> <span class="mf">-1.0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coerce"><a class="anchor" href="#_coerce"></a><a class="link" href="#_coerce">Coerce</a></h3>
<div class="paragraph">
<p>In C, 10 / 3 equals 0.3333333… In Lisp, 10 / 3 equals 10/3, allowing 10/3 * 3 to
return 10 while in C the result is 0.999999. This becomes problematic when
calculations are performed in Lisp and the result must be passed to a C style
function. coerce is used to force an object to a specific type. The following
code gives an example where coerce is required.</p>
</div>
<div class="paragraph">
<p>The result of <code>(/ width height)</code> is forced to the type <code>‘double-float</code></p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nc">ratio</span> <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">width</span> <span class="nv">height</span><span class="p">)</span> <span class="err">‘</span><span class="kt">double-float</span><span class="p">))</span>

<span class="p">(</span><span class="nv">gluPerspective</span> <span class="mf">60.0d0</span> <span class="nc">ratio</span> <span class="mf">1.0d0</span> <span class="mf">1024.0d0</span><span class="p">)</span><span class="err">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unions"><a class="anchor" href="#unions"></a><a class="link" href="#unions">C Unions</a></h3>
<div class="paragraph">
<p>The current version of Corman Lisp absolutely does not support unions. So the
following is not possible:</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="n">Uint8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">SDL_ActiveEvent</span> <span class="n">active</span><span class="p">;</span>
	<span class="n">SDL_KeyboardEvent</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">SDL_MouseMotionEvent</span> <span class="n">motion</span><span class="p">;</span>
	<span class="n">SDL_MouseButtonEvent</span> <span class="n">button</span><span class="p">;</span>
	<span class="n">SDL_JoyAxisEvent</span> <span class="n">jaxis</span><span class="p">;</span>
	<span class="n">SDL_JoyBallEvent</span> <span class="n">jball</span><span class="p">;</span>
	<span class="n">SDL_JoyHatEvent</span> <span class="n">jhat</span><span class="p">;</span>
	<span class="n">SDL_JoyButtonEvent</span> <span class="n">jbutton</span><span class="p">;</span>
	<span class="n">SDL_ResizeEvent</span> <span class="n">resize</span><span class="p">;</span>
	<span class="n">SDL_ExposeEvent</span> <span class="n">expose</span><span class="p">;</span>
	<span class="n">SDL_QuitEvent</span> <span class="n">quit</span><span class="p">;</span>
	<span class="n">SDL_UserEvent</span> <span class="n">user</span><span class="p">;</span>
	<span class="n">SDL_SysWMEvent</span> <span class="n">syswm</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SDL_Event</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is not as bad as it seems as it is possible to ‘fake’ a union in Lisp by
replacing it within a struct. So the C struct equivalent of the previous code,
as currently defined in the FFI, looks something like this.</p>
</div>
<div class="listingblock">
<div class="title">C code as defined in the Lisp SDL FFI</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Uint8</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">Uint8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1023</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SDL_Event</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, buffer is sized to be large enough to handle the largest variable in the
union. See Section <a href="#events">Processing Events</a> for an example of how a union is handled</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interfacing_to_sdl"><a class="anchor" href="#_interfacing_to_sdl"></a><a class="link" href="#_interfacing_to_sdl">Interfacing to SDL</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_initialization"><a class="anchor" href="#_initialization"></a><a class="link" href="#_initialization">Initialization</a></h3>
<div class="paragraph">
<p>Here is some standard code to initialize the SDL subsystems. Notice C uses the
<code>if</code> construct whereas idiomatic Lisp uses <code>when</code> — for which there is no C
equivalent. The reason is a matter of style and readability. Lisp does have an
<code>if</code> construct, but in Lisp the <code>if</code> implies an associated <code>else</code>. In this case
there is no <code>else</code> so we use <code>when</code> for the single decision branch.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">if</span><span class="p">(</span> <span class="n">SDL_Init</span><span class="p">(</span> <span class="n">SDL_INIT_VIDEO</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
   <span class="cm">/* Failed, exit. */</span>
   <span class="n">fprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Video initialization failed: %sn&#34;</span><span class="p">,</span>
        <span class="n">SDL_GetError</span><span class="p">(</span> <span class="p">)</span> <span class="p">);</span>
   <span class="n">quit_tutorial</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="mi">0</span> <span class="p">(</span><span class="nv">SDL_Init</span> <span class="nv">SDL_INIT_VIDEO</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">fformat</span> <span class="s">&#34;Video initialization failed: ~A &#34;</span> <span class="p">(</span><span class="nv">SDL_GetError</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="nv">quit</span> <span class="no">t</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_video_mode"><a class="anchor" href="#_setting_the_video_mode"></a><a class="link" href="#_setting_the_video_mode">Setting the video mode</a></h3>
<div class="paragraph">
<p>Many functions in SDL take parameters that are set using a bitwise <code>|</code> (or). The
Lisp equivalent is <code>logior</code>.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">flags</span> <span class="o">=</span> <span class="n">SDL_OPENGL</span> <span class="o">|</span> <span class="n">SDL_RESIZABLE</span><span class="p">;</span>
<span class="n">SDL_SetVideoMode</span><span class="p">(</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">flags</span> <span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">setf</span> <span class="nv">flags</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">SDL_OPENGL</span> <span class="nv">SDL_RESIZABLE</span><span class="p">))</span>
<span class="p">(</span><span class="nv">SDL_SetVideoMode</span> <span class="nv">width</span> <span class="nv">height</span> <span class="nv">bpp</span> <span class="nv">flags</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_main_loop"><a class="anchor" href="#_the_main_loop"></a><a class="link" href="#_the_main_loop">The Main Loop</a></h3>
<div class="paragraph">
<p>Games usually make use of a single loop that checks for events before executing
the game logic and redrawing the screen. Here is the C and equivalent Lisp code
for this main loop.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">while</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Process incoming events. */</span>
    <span class="n">process_events</span><span class="p">(</span> <span class="p">);</span>
    <span class="cm">/* Draw the screen. */</span>
    <span class="n">draw_screen</span><span class="p">(</span> <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">do</span> <span class="p">()</span>
    <span class="p">((</span><span class="nb">eql</span> <span class="vg">*quit*</span> <span class="no">t</span><span class="p">))</span>
	<span class="c1">; Process incoming events.</span>
    <span class="p">(</span><span class="nv">process-events</span><span class="p">)</span>
	<span class="c1">; Draw the screen.</span>
    <span class="p">(</span><span class="nv">draw-screen</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several loops available in Lisp (<code>loop</code>, <code>for</code>, <code>do</code>, <code>dotimes</code>,
<code>dolist</code>), and many more can be created using macros (e.g. <code>while</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="events"><a class="anchor" href="#events"></a><a class="link" href="#events">Processing Events</a></h3>
<div class="paragraph">
<p>As described in Section <a href="#unions">C Unions</a>, the current version of Corman Lisp does not
support unions. This poses a problem in that events are returned from
<code>SDL_PollEvent</code> in the form of an all-encompassing union.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="n">Uint8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">SDL_ActiveEvent</span> <span class="n">active</span><span class="p">;</span>
	<span class="n">SDL_KeyboardEvent</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">SDL_MouseMotionEvent</span> <span class="n">motion</span><span class="p">;</span>
	<span class="n">SDL_MouseButtonEvent</span> <span class="n">button</span><span class="p">;</span>
	<span class="n">SDL_JoyAxisEvent</span> <span class="n">jaxis</span><span class="p">;</span>
	<span class="n">SDL_JoyBallEvent</span> <span class="n">jball</span><span class="p">;</span>
	<span class="n">SDL_JoyHatEvent</span> <span class="n">jhat</span><span class="p">;</span>
	<span class="n">SDL_JoyButtonEvent</span> <span class="n">jbutton</span><span class="p">;</span>
	<span class="n">SDL_ResizeEvent</span> <span class="n">resize</span><span class="p">;</span>
	<span class="n">SDL_ExposeEvent</span> <span class="n">expose</span><span class="p">;</span>
	<span class="n">SDL_QuitEvent</span> <span class="n">quit</span><span class="p">;</span>
	<span class="n">SDL_UserEvent</span> <span class="n">user</span><span class="p">;</span>
	<span class="n">SDL_SysWMEvent</span> <span class="n">syswm</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SDL_Event</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Examining each struct within the union we see that <code>Uint8</code> type is used as the
type identifier.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Uint8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">Uint8</span> <span class="n">gain</span><span class="p">;</span>
	<span class="n">Uint8</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SDL_ActiveEvent</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Uint8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">Uint8</span> <span class="n">which</span><span class="p">;</span>
	<span class="n">Uint8</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">SDL_keysym</span> <span class="n">keysym</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SDL_KeyboardEvent</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore we are able to replace the union with the following struct in the FFI.
This is transparent to the programmer.</p>
</div>
<div class="listingblock">
<div class="title">C code as defined in the Lisp SDL FFI</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Uint8</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">Uint8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1023</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SDL_Event</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>All that remains is to check the type and ‘cast’ to the appropriate struct. In C
checking the type is something that must be done anyway. In Lisp, ‘cast’ means
referring to one type as another using <code>cref</code>. So for example, ‘casting’ from
<code>SDL_Event</code> to <code>SDL_KeyboardEvent</code> is as simple as…​</p>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Event</span> <span class="nv">sdl-event</span> <span class="nv">sdl::type</span><span class="p">)</span>

<span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_KeyboardEvent</span> <span class="nv">sdl-event</span> <span class="nv">sdl::type</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code describes the conversion to Lisp from C style event
processing.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">process_events</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">SDL_Event</span> <span class="n">event</span><span class="p">;</span>

    <span class="cm">/* Grab all the events off the queue. */</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">SDL_PollEvent</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">event</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">switch</span><span class="p">(</span> <span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">SDL_KEYDOWN</span><span class="p">:</span>
            <span class="cm">/* Handle key presses. */</span>
            <span class="n">handle_key_down</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">keysym</span> <span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">SDL_QUIT</span><span class="p">:</span>
            <span class="cm">/* Handle quit requests (like Ctrl-c). */</span>
            <span class="n">quit_tutorial</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">defun</span> <span class="nv">process-events</span> <span class="p">()</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sdl-event</span> <span class="p">(</span><span class="nv">ct:malloc</span> <span class="p">(</span><span class="nv">ct:sizeof</span> <span class="err">’</span><span class="nv">sdl:SDL_Event</span><span class="p">))))</span>
    <span class="c1">;; Grab all the events off the queue.</span>
    <span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="nv">poll-event</span> <span class="mi">1</span> <span class="p">(</span><span class="nv">sdl:SDL_PollEvent</span> <span class="nv">sdl-event</span><span class="p">)))</span>
        <span class="p">((</span><span class="nb">eql</span> <span class="nv">poll-event</span> <span class="mi">0</span><span class="p">)</span> <span class="err">‘</span><span class="nv">done</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">cond</span>
            <span class="c1">;; Here we check the type</span>
            <span class="p">((</span><span class="nb">eql</span> <span class="nv">sdl:SDL_KEYDOWN</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Event</span> <span class="nv">sdl-event</span> <span class="nv">sdl::type</span><span class="p">))</span>
                <span class="c1">;; Handle key presses.</span>
                <span class="c1">;; And then reference it as SDL_KeyboardEvent. Fortunately Lisp</span>
                <span class="c1">;; doesn’t care what we do.</span>
                <span class="p">(</span><span class="nv">handle-key-down</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_KeyboardEvent</span> <span class="nv">sdl-event</span> <span class="nv">sdl::keysym</span><span class="p">)))</span>
            <span class="p">((</span><span class="nb">eql</span> <span class="nv">sdl:SDL_QUIT</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_Event</span> <span class="nv">sdl-event</span> <span class="nv">sdl::type</span><span class="p">))</span>
                <span class="c1">;; Handle quit requests (like Ctrl-c)</span>
                <span class="p">(</span><span class="nb">setf</span> <span class="vg">*quit*</span> <span class="no">t</span><span class="p">))))))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The FFI forces us to create the <code>sdl-event</code> variable on the heap using malloc.
But because Lisp is garbage collected there is no need to use free, although
there is nothing stopping the reader from explicitly freeing a variable using
free. In the Lisp code above, the <code>sdl-event</code> variable has scope only within the
function <code>process-events</code>. Therefore the garbage collector will automatically
free the memory for <code>sdl-event</code> when it goes out of scope.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_events"><a class="anchor" href="#_handling_events"></a><a class="link" href="#_handling_events">Handling Events</a></h3>
<div class="paragraph">
<p>The following example describes how to handle key presses.</p>
</div>
<div class="listingblock">
<div class="title">C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_key_down</span><span class="p">(</span> <span class="n">SDL_keysym</span><span class="o">*</span> <span class="n">keysym</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span> <span class="n">keysym</span><span class="o">-&gt;</span><span class="n">sym</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">SDLK_ESCAPE</span><span class="p">:</span>
        <span class="n">quit_tutorial</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SDLK_SPACE</span><span class="p">:</span>
        <span class="n">should_rotate</span> <span class="o">=</span> <span class="o">!</span><span class="n">should_rotate</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Common Lisp</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="lisp"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">defun</span> <span class="nv">handle-key-down</span> <span class="p">(</span><span class="nv">keysym</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">cond</span>
        <span class="p">((</span><span class="nb">eql</span> <span class="nv">sdl:SDLK_ESCAPE</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_keysym</span> <span class="nv">keysym</span> <span class="nv">sdl::sym</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">setf</span> <span class="vg">*quit*</span> <span class="no">t</span><span class="p">))</span>
        <span class="p">((</span><span class="nb">eql</span> <span class="nv">sdl:SDLK_SPACE</span> <span class="p">(</span><span class="nv">ct:cref</span> <span class="nv">sdl:SDL_keysym</span> <span class="nv">keysym</span> <span class="nv">sdl::sym</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">setf</span> <span class="vg">*rotate*</span> <span class="p">(</span><span class="nb">not</span> <span class="vg">*rotate*</span><span class="p">)))))</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a><a class="link" href="#_conclusion">Conclusion</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hopefully this has helped you better understand how to make use of FFI bindings
for the Corman Common Lisp. If you have any corrections, additions or comments,
please let me know.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_version_history"><a class="anchor" href="#_version_history"></a><a class="link" href="#_version_history">Version History</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>17 August 2020: Version 0.3</p>
<div class="ulist">
<ul>
<li>
<p>Converted to AsciiDoc format</p>
</li>
</ul>
</div>
</li>
<li>
<p>15 December 2003: Version 0.2</p>
</li>
<li>
<p>11 December 2003: Version 0.1</p>
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<hr/>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://github.com/sharplispers/cormanlisp" class="bare">https://github.com/sharplispers/cormanlisp</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://www.libsdl.org/" class="bare">https://www.libsdl.org/</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://www.libsdl.org/release/SDL-1.2.15/docs/html/guidevideoopengl.html" class="bare">https://www.libsdl.org/release/SDL-1.2.15/docs/html/guidevideoopengl.html</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://github.com/sharplispers/cormanlisp/releases" class="bare">https://github.com/sharplispers/cormanlisp/releases</a>
</div>
</div>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>Between a REPL and a hard place</p>
      
      
        ©
        
        2021
         Luke Crook 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>

    </main>

    
      
      <script src="https://www.balooga.com/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
    

    

    

    

    

  </body>

</html>
